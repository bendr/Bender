<component xmlns="http://bender.igel.co.jp" href="ui-elem.xml" id="canvas">

  <property name="base-class" as="string" value="canvas"/>
  <property name="width"/>
  <property name="height"/>
  <property name="stroke" as="string" value="black"/>
  <property name="stroke-width" as="number" value="1"/>
  <property name="bg"/>
  <property name="fg"/>
  <property name="down" as="boolean" value="false"/>

  <view xmlns:html="http://www.w3.org/1999/xhtml">
    <html:div class="`base\-class `class `enabled\-class"
      style="width:`(width)px;height:`(height)px">
      <html:canvas id="bg" width="`width" height="`height"/>
      <html:canvas id="fg" width="`width" height="`height"/>
    </html:div>
  </view>

  <watch>
    <get event="ready"/>
    <set property="bg" value="@bg.getContext('2d')"/>
    <set property="fg" value="@fg.getContext('2d')"/>
    <set match="`fg">
      `fg.lineCap = "round";
      `fg.lineJoin = "round";
    </set>
  </watch>

  <watch>
    <get property="fg"/>
    <get property="stroke"/>
    <set match="`fg">
      `fg.strokeStyle = `stroke;
    </set>
  </watch>

  <watch>
    <get property="fg"/>
    <get property="stroke-width"/>
    <set match="`fg">
      `fg.lineWidth = `stroke\-width;
    </set>
  </watch>

  <watch>
    <get select="@fg" dom-event="mousedown" prevent-default="true"
      match="`fg &amp;&amp; `enabled &amp;&amp; $in.button === 0"/>
    <get select="@fg" dom-event="touchstart" prevent-default="true"
      match="`fg &amp;&amp; `enabled"/>
    <set property="down">
      `fg.beginPath();
      var p = flexo.event_offset_pos($in, @fg);
      `fg.moveTo(p.x, p.y);
      return true;
    </set>
  </watch>

  <watch>
    <get select="$document" dom-event="mousemove"/>
    <get select="@fg" dom-event="touchmove"/>
    <set match="`down">
      var p = flexo.event_offset_pos($in, @fg);
      `fg.lineTo(p.x, p.y);
      `fg.clearRect(0, 0, @fg.width, @fg.height);
      `fg.stroke();
    </set>
  </watch>

  <watch>
    <get select="$document" dom-event="mouseup"/>
    <get select="@fg" dom-event="touchend"/>
    <set property="down" match="`down">
      `bg.drawImage(@fg, 0, 0);
      `fg.clearRect(0, 0, @fg.width, @fg.height);
      return false;
    </set>
  </watch>

</component>
