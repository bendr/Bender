<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bender runtime</title>
    <meta charset="UTF-8">
    <style>
      html, body { height: 100% }
      body { font-family: "Helvetica Neue", Helvetica, sans-serif;
        font-size: 16px; background-color: #aaa; margin: 0; }
      a { color: #102040; text-decoration: none; }
      #back { position: absolute; right: 0; top: 0; }
      #top a { color: #40bfff; }
      #top { background-color: #102040; color: white; }
      #tool-bar { background-color: #40bfff; }
      #output { background-color: white; }
      #status.error { background-color: #ff4040; color: white; }
      #status.warning { background-color: #ff7f40; color: white; }
      #status.ok { background-color: #40ff40; }
      #bottom { background-color: #aaa; font-size: 12px; text-align: center;
        margin-top: 4em; }
      #top p, #tool-bar p, #bottom p, #status p { margin: 0; padding: 8px; }
      .CodeMirror { font-family: Menlo, monospace !important;
        background-color: white; font-size: 14px; }
      .CodeMirror-scroll { height: auto !important; overflow-y: hidden;
        overflow-x: auto; width: 100%; }
      #bender-target { background-color: white; display: inline-block;
        margin: 8px;}
      .hidden { display: none !important; }
    </style>
    <script src="core/flexo.js"></script>
    <script src="core/bender.js"></script>
    <script src="misc/codemirror.js"></script>
    <link href="misc/codemirror.css" rel="stylesheet">
    <script src="misc/xmlpure.js"></script>
  </head>
  <body>
    <div id="top">
      <p>Bender runtime</p>
      <p id="back"><a href="/">Back</a></p>
    </div>
    <div id="tool-bar">
      <p>
        <input type="file" onchange="file_select(event)"/>
      </p>
    </div>
    <div id="output">
      <div id="bender-target" class="hidden"></div>
    </div>
    <div id="status" class="warning">
      <p>Not ready.</p>
    </div>
    <div id="input">
    </div>
    <div id="bottom">
      <p>
        Copyright © 2011, <a href="http://www.igel.co.jp">IGEL Co., Ltd.</a>
      </p>
    </div>
    <script>

      var editor = CodeMirror(document.getElementById("input"),
        { lineNumbers: true, readOnly: true });
      var reader = new FileReader();
      var parser = new DOMParser();
      var target = document.getElementById("bender-target");

      document.body.addEventListener("dragover", dragover, false);
      document.body.addEventListener("drop", drop, false);

      function dragover(e)
      {
        e.preventDefault();
        e.stopPropagation();
        e.dataTransfer.dropEffect = "copy";
      }

      function drop(e)
      {
        e.preventDefault();
        e.stopPropagation();
        open_file(e.dataTransfer.files[0]);
      }

      function file_select(event)
      {
        open_file(event.target.files[0]);
      }

      function open_file(file)
      {
        if (file) {
          warn("Loading {0}...".fmt(file.name));
          target.innerHTML = "";
          flexo.add_class(target, "hidden");
          reader.onerror = function(e) {
            error("{0}: Could not read file as text.".fmt(file.name));
          };
          reader.onload = function(e) {
            editor.setValue(e.target.result);
            var doc = parser.parseFromString(e.target.result, "text/xml");
            if (doc && doc.documentElement) {
              try {
                var context = bender.create_context(document);
                var app = context.import(doc.documentElement);
                var instance = app.instantiate();
                if (instance.render(target, true)) {
                  flexo.remove_class(target, "hidden");
                  ok("{0}: OK".fmt(file.name));
                  bender.notify(instance, "@ready");
                } else {
                  warn("{0}: Component has no view.".fmt(file.name));
                }
              } catch (e) {
                error(e.message);
                target.appendChild(document.importNode(doc.documentElement,
                  true));
              }
            } else {
              error("{0}: Could not read file as XML.".fmt(file.name));
            }
          };
          reader.readAsText(file);
        }
      }

      var status_ = document.getElementById("status");

      function ok(message)
      {
        status_.className = "ok";
        status_.innerHTML = "<p>{0}</p>".fmt(message);
      }

      function warn(message)
      {
        status_.className = "warning";
        status_.innerHTML = "<p>{0}</p>".fmt(message);
      }

      function error(message)
      {
        status_.className = "error";
        status_.innerHTML = "<p>{0}</p>".fmt(message);
      }

      ok("⚑ Please select a file to run.");

    </script>
  </body>
</html>
