<!DOCTYPE html>
<html lang="en">
  <head>
    <title>‚öê Bender runtime w/ params</title>
    <meta charset="UTF-8">
    <meta http-equiv="cache-control" content="no-cache">
    <style>
      body {
        font-family: Univers, "Helvetica Neue", Helvetica, sans-serif;
        padding: 0;
        margin: 0;
      }
      .app { padding: 4px 8px; }
    </style>
    <script src="../flexo-new.js"></script>
    <script src="../flexo-svg.js"></script>
    <script src="../bender.js"></script>
  </head>
  <body>
    <script>
      "use strict";

      var args = flexo.get_args(), watches = [], context, load;

      load = function () {
        this.uses.params.clear();
        watches.forEach(function (w) { flexo.safe_remove(w); });
        watches = [];
        var component = context.querySelector("component");
        [].forEach.call(this.uses.app.component.attributes, function (attr) {
          var name, type = attr.namespaceURI === flexo.BENDER_B_NS ? "b" :
              attr.namespaceURI === flexo.BENDER_E_NS ? "e" :
                  attr.namespaceURI === flexo.BENDER_F_NS ? "f" :
                      attr.namespaceURI === flexo.BENDER_J_NS ? "j" : "";
          if (type) {
            name = attr.localName;
            this.uses.params.add_param(type, name,
              this.uses.app.properties[name]);
            watches.push(component.appendChild(component.$("watch",
              component.$("get", { use: "params", property: name }),
              component.$("set", { use: "app", property: name }))));
            watches.push(component.appendChild(component.$("watch",
              component.$("get", { use: "app", property: name }),
              component.$("set", { use: "params", property: name }))));
            console.log("Added param:", type, name, this.uses.app.properties[name]);
            console.log(component);
          }
        }, this);
      };

      args.id = "app";
      context = bender.create_context(document.body);
      if (args.href) {
        context.appendChild(
          context.$("component",
            context.$("view",
              context.$("use", { href: "params-bar.xml", id: "params" }),
              context.$("html:div.app",
                context.$("use", args))),
            context.$("watch",
              context.$get({ use: "params", event: "@refresh" }, function () {
                this.uses.app.component._refresh();
              })),
            context.$("watch",
              context.$get({ use: "$self", event: "@rendered" }, load)))
        );
        context.appendChild(context.$("use", { q: "component" }));
      }

    </script>
  </body>
</html>
