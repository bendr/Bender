<!DOCTYPE html>
<html lang="en">
  <head>
    <title>‚öê Bender dynamic tree view</title>
    <meta charset="UTF-8">
    <meta http-equiv="cache-control" content="no-cache">
    <style>
      body {
        font-family: Univers, "Helvetica Neue", Helvetica, sans-serif;
        margin: 0;
        padding: 0;
      }
      .app { padding: 4px 8px; }
      .__refreshed { background-color: #ff0; }
    </style>
    <script src="../flexo.js"></script>
    <script src="../bender.js"></script>
  </head>
  <body>
    <script>

      var context = bender.create_context(document.body);
      context.appendChild(context.$("use", { href: "tree.xml", id: "tree" }));

      var args = flexo.get_args({ "class": "app" });
      args.id = "app";
      if (!args.href) {
        args.q = "app";
        context.appendChild(context.$("app",
          context.$("title", "Untitled Bender App"),
          context.$("view")));
      }
      context.appendChild(context.$("use", args));

      var init = false;

      context.appendChild(context.$("watch",
        context.$get({ use: "$self", event: "@rendered" },
          function() {
            if (!init) {
              init = true;
              this.uses.tree.use.appendChild(tree_node(this.uses.app.use));
              this.uses.tree.use.appendChild(
                tree_node(this.uses.app.component));
            }
          })));

      // Make a use node in the display tree from a node in the app
      function tree_node(app_node)
      {
        var use = context.$("use", { href: "tree.xml#elem" });
        flexo.listen(use, "@instance", function(e) {
            e.instance.app_node = app_node;
          });
        return use;
      }

    </script>
  </body>
</html>
