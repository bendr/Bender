<!DOCTYPE html>
<html lang="en">
  <head>
    <title>‚öê Bender tree view</title>
    <meta charset="UTF-8">
    <meta http-equiv="cache-control" content="no-cache">
    <style>
      body {
        font-family: Univers, "Helvetica Neue", Helvetica, sans-serif;
        margin: 0;
        padding: 0;
      }
      .app { padding: 4px 8px; }
      .__refreshed { background-color: #ff0; }
    </style>
    <script src="../flexo.js"></script>
    <script src="../bender.js"></script>
  </head>
  <body>
    <script>

      var context = bender.create_context(document.body);
      context.appendChild(context.$("use", { href: "tree.xml", id: "tree" }));
      var args = flexo.get_args({ "class": "app" });
      args.id = "app";
      if (!args.href) {
        args.q = "app";
        context.appendChild(context.$("app",
          context.$("title", "Untitled Bender App"),
          context.$("view",
            context.$("html:p", "Hello, World!"))));
      }
      context.appendChild(context.$("use", args));
      context.appendChild(context.$("watch",
        context.$get({ use: "$self", event: "@rendered" }, function() {
            this.uses.tree.use.appendChild(tree_node(this.uses.app.use));
            this.uses.tree.use.appendChild(tree_node(this.uses.app.component));
          })));
      context.appendChild(context.$("watch",
        context.$get({ use: "$context", event: "@refresh" }, function(e) {
            var n = e.instance.component.__tree_node;
            if (n) {
              flexo.log("refresh:", n);
            }
          })));

      function tree_node(node)
      {
        if (node.nodeType === 1) {
          // New element
          var use = context.$("use", { href: "tree.xml#elem",
            "e:tag": node.localName, "e:ns": node.namespaceURI });
          node.__tree_node = use;
          // Attributes (skip namespace declarations)
          [].forEach.call(node.attributes, function(attr) {
              if (!/^xmlns:?/.test(attr.name)) {
                use.appendChild(context.$("use", { href: "tree.xml#attr",
                  "e:ns": attr.namespaceURI, "e:name": attr.name,
                  "e:value": attr.value }));
              }
            });
          // Child nodes (text and elements)
          var ul = use.appendChild(context.$("html:ul"));
          [].forEach.call(node.childNodes, function(ch) {
              var li = tree_node(ch);
              if (li) ul.appendChild(li);
            });
          if (ul.childNodes.length === 0) use.removeChild(ul);
          return use;
        } else if ((node.nodeType === 3 || node.nodeType === 4) &&
          /\S/.test(node.textContent)) {
          // Non-whitespace text node
          // TODO keep whitespace when necessary
          var use = context.$("use", { href: "tree.xml#text" }, node.textContent);
          use.__node = node;
          return use;
        }
      };

    </script>
  </body>
</html>
