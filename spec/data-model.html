<!DOCTYPE html>
<html lang="en">
  <head>
    <title>The Bender Data Model (v0.9, February 2014)</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="doc.css">
  </head>
  <body>
    <h1>The Bender Data Model</h1>
    <p>Version 0.9, February 2014</p>
    <p>See also <a href="processing-model.html">the Bender Processing Model</a>
    and <a href="xml-api.html">the Bender XML and Javascript API</a> for
    reference.</p>

    <h2>Preliminaries</h2>
    <p>We use a loose notation to describe the data and processing model of
    Bender in terms of objects and prototype, and an implied standard library
    for processing lists, managing DOM elements, &amp;c.</p>
    <ul>
      <li>The data model is defined in terms of <em>Objects</em> and
      <em>data</em>. <code>Object</code>s are defined by their
      <em>properties</em>. A property has a name and a value, which may be any
      <code>data</code>: a boolean, a number, a string, a number, an
      <code>Object</code>, or the undefined value.</li>
      <li>A <em>Function</em> is a callable <code>Object</code>. We use lambda
      notation for anonymous functions. The pseudo-code used is a simple
      expression-based language with a liberal syntax that allows side
      effects (functions may not return any value) and mutation of data
      structures.</li>
      <li><em>O</em> <code>&lt;</code> <em>P</em> means that the object
      <em>O</em> is <em>created</em> from the object <em>P</em>. <em>O</em>
      inherits all of the properties of <em>P</em>, along with their values.
      <em>O</em> may have additional properties, and may override any property
      of <em>P</em>.</li>
      <li><em>O</em><code>.</code><em>x</em> means the property <em>x</em> of
      object <em>O</em>.</li>
      <li><code>?</code> means that the property may be undefined.</li>
      <li><code>*</code> means a list of zero or more objects.</li>
      <li><code>+</code> means a list of one or more objects.</li>
      <li><code>=</code> means that the object property on the left-hand side
      has a default value, defined on the right-hand side.</li>
      <li><code>[]</code> means an empty list.</li>
      <li><code>"..."</code> means a string (which can be considered as a list
      of characters.)</li>
      <li><em>L</em> <code>:</code> <em>x</em> means appending <em>x</em> to the
      list <em>L</em>.</li>
      <li><code>::</code> is the concatenation of two lists.</li>
    </ul>


    <h2>Nodes</h2>

    <div class="def" id="Node">
      <p>The Bender data model deals with two kinds of tree structures: trees
      of <em>components</em>, defining the high-level structure of a Bender
      application; and trees of <em>elements</em>, defining the contents and
      layout of a given component. Together, these trees define a <em>component
        graph</em>. Both trees are defined by tree <code>Node</code>s.</p>
      <div>
        <pre>Node &lt; Object
  Node?    parent
  Node*    children
  string?  id</pre>
        <ul>
          <li><code>parent</code> is the parent <code>Node</code>, if any, of
          the node. The <em>root</em> of a tree has no <code>parent</code>.</li>
          <li><code>children</code> is the ordered list of child nodes of the
          node. A <em>leaf</em> in a tree has zero children.</li>
          <li><code>id</code> is an optional string identifier. The identifier
          must be unique within the scope of a <code>Component</code> (see
          below.)</li>
        </ul>
      </div>
    </div>


    <h2>Components</h2>

    <div class="def" id="Component">
      <p>The <code>Component</code> is the basic unit of functionality in
      Bender. Components are defined in terms of other components, both through
      <em>composition</em> (a component may contain child components) and
      <em>inheritance</em> (a component may inherit from a prototype
      component.)</p>
      <p>A <em>top-level component</em> is a <code>Component</code> with no
      <code>parent</code>, <em>i.e.</em>, it is the root of a component tree.
      There is no separate concept of “application” in Bender; an application is
      a top-level component.</p>
      <p>The <em>scope</em> of a <code>component</code> <em>C</em> covers the
      component tree that <em>C</em> is in and the view tree that its
      <code>View</code> is in. The scope does not cover the whole component
      graph, as it excludes the prototype of <em>C</em> as well as the
      prototypes of its parent and children.</p>
      <div>
        <pre>Component &lt; Node
  Component?  prototype
  Property*   property-definitions
  data*       properties
  View        view
  Watch*      watches</pre>
        <ul>
          <li><code>prototype</code> is the <code>Component</code>
          from which this component is derived, if any. The prototype must not
          be a component in the same component tree, nor can there be any cycle
          in the prototype chain.</li>
          <li><code>property-definitions</code> is the list of all
          <code>Property</code> definitions for this component, indexed by their
          name. This includes the property definitions of the prototype
          component.</li>
          <li><code>properties</code> is the list of all property values for
          this component, indexed by their name.</li>
          <li><code>view</code> is the root of the view tree of this
          component.</li>
          <li><code>watches</code> is the unordered list of all
          <code>Watch</code>es of the component.</li>
        </ul>
      </div>
    </div>


    <h2>Properties</h2>

    <p>Properties are named values that are used to parametrize both the
    appearance and behavior of a component. A property value may be any
    <code>data</code>.</p>

    <div class="def" id="Adapter">
      <p>An <code>Adapter</code> filters and transforms an input value into an
      output value, with an optional delay, in the context of a <em>target</em>
      <code>Node</code>.</p>
      <div>
        <pre>Adapter &lt; Object
  Node      target
  Function  value = λx x
  Function  match = λx true
  number?   delay</pre>
        <ul>
          <li><code>target</code> is the target node of this adapter. The role
          of the target depends on the actual kind of adapter.</li>
          <li><code>value</code> is a function transforming an input value into
          an output value. The default is the identity function, which returns
          its input.</li>
          <li><code>match</code> is a predicate that takes an input value and
          returns a boolean value that is true if and only if the input is
          <em>valid</em>. If an input is invalid, no value is output by the
          adapter. The default is a function that returns true for any input,
          treating any input value as valid.</li>
          <li><code>delay</code> is the delay before an output value is
          returned. When <code>delay</code> is undefined, there is no delay, and
          the output value is returned synchronously. When <code>delay</code> is
          0, then the output value is returned as soon as possible, but
          asynchronously. When <code>delay</code> is larger than 0, then this is
          the delay in milliseconds before which an output value is
          returned.</li>
        </ul>
      </div>
    </div>

    <div class="def" id="Property">
      <p>A <code>Property</code> is the <em>definition</em> of a property of a
      Bender component.</p>
      <div>
        <pre>Property &lt; Adapter
  Component  component
  string     name</pre>
      </div>
      <ul>
        <li><code>component</code> points back to the owner
        <code>Component</code>.</li>
        <li><code>name</code> is the name of the property. The name of a
        <code>Property</code> must be unique for a <code>Component</code>,
        but other components in the same scope may have a <code>Property</code>
        with the same name.</li>
      </ul>
    </div>


    <h2>View and elements</h2>

    <p>The <em>view</em> of a <code>Component</code> describes its contents and
    layout as a tree of <code>Element</code>s. These elements describe how a
    component is rendered and which other <code>Component</code>s it
    contains.</p>

    <div class="def" id="Element">
      <p><code>Element</code>s are <code>Node</code>s describing the view of a
      <code>Component</code>.</p>
      <div>
        <pre>Element &lt; Node
  Component  component</pre>
        <ul>
          <li><code>component</code> is the <code>Component</code> that the
          element is in the view of. Except for <code>View</code>, this is the
          <code>component</code> of the closest <code>View</code> ancestor
          element.</li>
        </ul>
      </div>
    </div>

    <div class="def" id="View">
      <p>The <code>View</code> element is a container for the view of a
      component.</p>
      <div>
        <pre>View &lt; Element</pre>
        <ul>
          <li><strong>Note</strong>: for a <code>View</code> <em>V</em>,
          <code>component</code> is the <code>Component</code> <em>C</em> such
          that <code>C.view</code> is <em>V</em>. Additionally, if <em>V</em>
          has a <code>parent</code>, then there exists a component <em>P</em>
          such that <code>V.parent.component</code> is <em>P</em>, and
          <code>C.parent</code> is <em>P</em>.</li>
        </ul>
      </div>
    </div>

    <div class="def" id="Content">
      <p>The <code>Content</code> element provides an extension point for the
      view of derived components.</p>
      <div>
        <pre>Content &lt; Element</pre>
        <ul>
          <li><strong>Note</strong>: the <code>children</code> of a
          <code>Content</code> element are the default contents for the
          element.</li>
        </ul>
      </div>
    </div>

    <div class="def" id="DOMElement">
      <p>The <code>DOMElement</code> element represents a foreign element
      (<em>i.e.</em>, not a Bender element.) Its properties map to properties of
      DOM elements.</p>
      <div>
        <pre>DOMElement &lt; Element
  string  ns
  string  name
  data*   attributess</pre>
        <ul>
          <li><code>ns</code> is the namespace URI of the DOM element.</li>
          <li><code>name</code> is the local name of the DOM element.</li>
          <li><code>attributes</code> is a list of attribute values of the DOM
          element, indexed first by namespace URI, then by local name.</li>
        </ul>
      </div>
    </div>

    <div class="def" id="Attribute">
      <p>The <code>Attribute</code> element represents an attribute of its
      parent element, similarly to a DOM attribute node.</p>
      <div>
        <pre>Attribute &lt; Element
  string  ns
  string  name</pre>
        <ul>
          <li><code>ns</code> is the namespace URI of the attribute.</li>
          <li><code>name</code> is the local name of the attribute.</li>
          <li><strong>Note</strong>: the value of the attribute is defined by
          the concatenation of the <code>text</code> of its <code>Text</code>
          child elements. Other children are ignored.</li>
        </ul>
      </div>
    </div>

    <div class="def" id="Text">
      <p>The <code>Text</code> element represents a text node, similarly to a
      DOM text node or CDATA section. Contrary to DOM text nodes,
      <code>Text</code> elements may have an ID.</p>
      <div>
        <pre>Text &lt; Element
  string  text</pre>
        <ul>
          <li><code>text</code> is the text content of the element.</li>
          <li><strong>Note</strong>: a <code>Text</code> element should not
          have children and should be a leaf node.</li>
        </ul>
      </div>
    </div>


    <h2>Watches</h2>
    <p>Watches describe the behavior of a component. A <em>watch</em>
    generalizes the concept of the <em>event listener</em> by allowing
    components to listen to event notifications from rendered elements
    (<em>e.g.</em>, DOM events), event notifications and property changes from
    <code>Component</code>s; and associating these occurrences with
    corresponding actions, such as generating new event notifications, setting
    new values for properties, or mutating a component.</p>

    <h3>Watch</h3>

    <div class="def" id="Watch">
      <p>A <code>Watch</code> has <em>inputs</em> (incoming event notifications
      or property changes) and <em>outputs</em> (outgoing event notifications,
      property changes, or mutations.)</p>
      <div>
        <pre>Watch &lt; Object
  Component  component
  Get*       gets
  Set*       sets</pre>
        <ul>
          <li><code>component</code> is the owner <code>Component</code> of
          this watch.</li>
          <li><code>gets</code> is the unordered list of <code>Get</code>s
          (inputs) of this watch.</li>
          <li><code>sets</code> is the unordered list of <code>Set</code>s
          (outputs) of this watch.</li>
        </ul>
      </div>
    </div>


    <h3>Get</h3>

    <div class="def" id="Get">
      <p>A <code>Get</code> is a watch input. There are two different kinds of
      input: a <em>property input</em>, or an <em>event input</em>.</p>
      <div>
        <pre>Get &lt; Adapter
  Watch  watch</pre>
        <ul>
          <li><code>watch</code> is the owner <code>Watch</code>.</li>
        </ul>
      </div>
    </div>

    <div class="def" id="GetProperty">
      <p>A <code>GetProperty</code> is a property input.</p>
      <div>
        <pre>GetProperty &lt; Get
  Property  property</pre>
        <ul>
          <li><code>property</code> is the <code>Property</code> that is
          monitored.</li>
          <li><strong>Note</strong>: the <code>target</code> of a
          <code>GetProperty</code> must be a <code>Component</code> for which
          <code>property</code> is defined.</li>
        </ul>
      </div>
    </div>

    <div class="def" id="GetEvent">
      <p>A <code>GetEvent</code> is an event input.</p>
      <div>
        <pre>GetEvent &lt; Get
  string  type</pre>
        <ul>
          <li><code>type</code> is the type of the event that is being listened
          to.</li>
          <li><strong>Note</strong>: the <code>target</code> of a
          <code>GetEvent</code> must be a <code>Component</code> or a
          <code>DOMElement</code>. <code>type</code> is then interpreted as the
          type of a Bender or DOM event (respectively.)</li>
        </ul>
      </div>
    </div>


    <h3>Set</h3>

    <div class="def" id="Set">
      <p>A <code>Set</code> is a watch output. There are five different kinds
      of output: a <em>plain output</em>, a <em>component property output</em>,
      a <em>node proprety output</em>, an <em>attribute output</em>, or an
      <em>event output</em>.</p>
      <div>
        <pre>Set &lt; Adapter
  Watch  watch</pre>
        <ul>
          <li><code>watch</code> is the owner <code>Watch</code>.</li>
          <li><strong>Note</strong>: this is a <em>plain</em> output and is used
          for side effects only, such as mutating the contents of a
          component, or having effects outside of the scope of Bender.</li>
        </ul>
      </div>
    </div>

    <div class="def" id="SetProperty">
      <p>A <code>SetProperty</code> is a <code>Component</code> property
      output.</p>
      <div>
        <pre>SetProperty &lt; Set
  Property  property</pre>
        <ul>
          <li><code>property</code> is the <code>Property</code> to be set.</li>
          <li><strong>Note</strong>: <code>target</code> must be a
          <code>Component</code>.</li>
        </ul>
      </div>
    </div>

    <div class="def" id="SetNodeProperty">
      <p>A <code>SetNodeProperty</code> is a <code>Node</code> property
      output.</p>
      <div>
        <pre>SetNodeProperty &lt; Set
  string  name</pre>
        <ul>
          <li><code>name</code> is the name of the property to be set on the
          target <code>Node</code>.
        </ul>
      </div>
    </div>

    <div class="def" id="SetAttribute">
      <p>A <code>SetAttribute</code> is an attribute output.</p>
      <div>
        <pre>SetAttribute &lt; Set
  string?  ns
  string   name</pre>
        <ul>
          <li><code>ns</code> is the namespace URI of the attribute to
          set.</li>
          <li><code>name</code> is the local name of the attribute to set.</li>
          <li><strong>Note</strong>: the <code>target</code> must be a
          <code>DOMElement</code>.</li>
        </ul>
      </div>
    </div>

    <div class="def" id="SetEvent">
      <p>A <code>SetEvent</code> is an event output.</p>
      <div>
        <pre>SetEvent &lt; Set
  string  type</pre>
        <ul>
          <li><code>type</code> is the type of the event to generate:
          <ul>
            <li>if the <code>target</code> is a <code>DOMElement</code>, then a
            DOM event is synthesized;
            <li>otherwise, the <code>target</code> must be a
            <code>Component</code>, and a Bender event notification is
            generated.</li>
        </ul>
      </div>
    </div>

    <h3 id="example">Example</h3>
    <p>Consider a non-trivial component (called <em>Panel</em>) <a
      href="xml-api.html#s11n">defined in XML</a> as follows:</p>

    <div class="def" id="Panel">
      <div>
        <pre>&lt;component xmlns="http://bender.igel.co.jp" id="Panel"&gt;
  &lt;property name="n" value="0"/&gt;
  &lt;view xmlns:html="http://www.w3.org/1999/xhtml"&gt;
    &lt;html:div&gt;
      &lt;text id="text-n"/&gt;
      &lt;component href="button.xml" id="Plus" label="+"/&gt;
      &lt;component href="button.xml" id="Minus" label="—"/&gt;
    &lt;/html:div&gt;
  &lt;/view&gt;
  &lt;watch&gt; <span class="watch">1</span>
    &lt;get select="@Plus" event="pushed"/&gt;
    &lt;set property="n" value="`n + 1"/&gt;
  &lt;/watch&gt;
  &lt;watch&gt; <span class="watch">2</span>
    &lt;get select="@Minus" event="pushed"/&gt;
    &lt;set property="n" value="`n - 1"/&gt;
  &lt;/watch&gt;
  &lt;watch&gt; <span class="watch">3</span>
    &lt;get property="n"/&gt;
    &lt;set select="@text-n"/&gt;
    &lt;set select="@Minus" property="enabled" value="$in &amp;gt; 0"/&gt;
  &lt;/watch&gt;
&lt;/component&gt;</pre>
        <ul>
          <li><code>Panel</code> has a <code>Property</code> named
          <code>n</code>, as specified by the <code>name</code> attribute, with
          an initial value of 0, as specified by the <code>value</code>
          attribute.</li>
          <li><code>Panel</code> has a <code>View</code> with a
          <code>DOMElement</code> child (a HTML <code>div</code> element), with
          three children. The first is a <code>Text</code> child with ID
          <code>text-n</code>, as specified by the <code>id</code>
          attribute.</li>
          <li><code>Panel</code> also has two child components with the ID
          <code>Plus</code> and <code>Minus</code> (as specified by the
          <code>id</code> attribute), both inheriting from the
          <code>Button</code> component shown below (as specified by the
          <code>href</code> attribute), with a different initial value for the
          <code>label</code> property (as specified by the <code>label</code>
          attribute), and an empty view.</li>
          <li>The <code>Watch</code> <span class="watch">1</span> has one
          input and one output:
          <ul>
            <li>the input is a <code>GetEvent</code>. The <code>target</code> is
            the <code>Plus</code> <code>Component</code>, as specified by the
            <code>select</code> attribute. The input is listening to a Bender
            event of type <code>pushed</code>;</li>
            <li>the output is a <code>SetProperty</code>. The target property is
            the <code>n</code> <code>Property</code> of the <code>Panel</code>
            component, as specified by the <code>property</code> attribute. The
            output value is one plus the value of <code>n</code>, as specified
            by the <code>value</code> element.</li>
          </ul>
          (The effect of this watch is to increment the value of <code>n</code>
          when the <code>Plus</code> button is pushed.)</li>
          <li>The <code>Watch</code> <span class="watch">2</span> is similar,
          with the input target being the <code>Minus</code>
          <code>Component</code>, and the output value being 1 minus the value
          of <code>n</code>.  The effect of this watch is to decrement the value
          of <code>n</code> when the <code>Plus</code> button is pushed.</li>
          <li>The <code>Watch</code> <span class="watch">3</span> has one input
          and two outputs:
          <ul>
            <li>the input is a <code>GetProperty</code>. The target property is
            the <code>n</code> <code>Property</code> of <code>Panel</code>.</li>
            <li>the first output is a <code>SetNodeProperty</code>. The target
            is the <code>text-n</code> <code>Text</code> element; by default,
            the property to set is <code>text</code>;</li>
            <li>the second output is a <code>SetProperty</code>. The target
            property is the <code>enabled</code> <code>Property</code> of the 
            <code>Minus</code> <code>Component</code>. The output value is
            a boolean value that is true if and only if the input value is
            greater than 0. (Because this is XML, the <code>&gt;</code>
            character must be escaped.)</li>
          </ul>
          </li>
        </ul>
      </div>
    </div>

    <div class="def" id="Button">
      <p>This second component is the <code>Button</code> prototype of both
      <code>Plus</code> and <code>Minus</code> buttons above.</p>
      <div>
        <pre>&lt;component xmlns="http://bender.igel.co.jp" id="Button"&gt;
  &lt;property name="label" as="string" value="Label"&gt;
  &lt;property name="enabled" value="true"&gt;
  &lt;property name="pushed" value="false"&gt;
  &lt;view xmlns:html="http://www.w3.org/1999/xhtml"&gt;
    &lt;html:div id="frame"&gt;
      &lt;content&gt;
        &lt;text id="text-label"/&gt;
      &lt;/content&gt;
    &lt;/html:div&gt;
  &lt;/view&gt;
  &lt;watch&gt; <span class="watch">4</span>
    &lt;get property="label"/&gt;
    &lt;set select="@text-label"/&gt;
  &lt;/watch&gt;
  &lt;watch&gt; <span class="watch">5</span>
    &lt;get select="@frame" event="mousedown"/&gt;
    &lt;set property="down" match="`enabled" value="true"/&gt;
  &lt;/watch&gt;
  &lt;watch&gt; <span class="watch">6</span>
    &lt;get select="@frame" event="mouseup"/&gt;
    &lt;set event="pushed" match="`down"/&gt;
    &lt;set property="down" value="false"/&gt;
  &lt;/watch&gt;
  &lt;watch&gt; <span class="watch">7</span>
    &lt;get property="down"/&gt;
    &lt;set select="@frame" attribute="@class" value="$in ? 'down' : ''/&gt;
  &lt;/watch&gt;
  &lt;watch&gt; <span class="watch">8</span>
    &lt;get property="enabled"/&gt;
    &lt;set select="@frame" attribute="@class" value="$in ? '' : 'disabled'/&gt;
  &lt;/watch&gt;
&lt;/component&gt;</pre>
        <ul>
          <li><code>Button</code> has a <code>Property</code> named
          <code>label</code> with initial value <code>"Label"</code>. The
          <code>as</code> attribute specifies that the value should be
          interpreted as a character string.</li>
          <li><code>Button</code> has a <code>Property</code> named
          <code>enabled</code> with initial value <code>true</code>.</li>
          <li><code>Button</code> has a <code>Property</code> named
          <code>down</code> with initial value <code>false</code>.</li>
          <li><code>Button</code> has a <code>View</code> containing a
            <code>DOMElement</code> (a HTML <code>div</code> element with ID
            <code>frame</code>), containing a <code>Content</code> element,
            containing a <code>Text</code> element with ID
            <code>text-label</code>.</li>
          <li><code>Button</code> has no child <code>Component</code>.</li>
          <li><span class="TODO">TODO: describe <code>Watch</code>es <span
              class="watch">4</span> through <span class="watch">8</span> in
            detail. <code>match</code> properties.</li>
        </ul>
      </div>
    </div>

    <p>The figure below shows the component graph of <code>Panel</code>. Black
    arrows are parent/child relationships. Pink arrows point to a prototype.
    Blue arrows point from a <code>Component</code> to its <code>View</code>.
    <code>Component</code> nodes are shown as ellipses, while view
    <code>Element</code>s are shown as boxes. Scopes are enclosed in green
    boxes.</p>

    <figure>
      <img src="fig/panel.svg">
      <figcaption>Component and view tree of <code>Panel</code>.</figcaption>
    </figure>

    <p>This example is used again to illustrate <a
      href="processing-model.html">processing model of Bender</a>.</p>

  </body>
</html>
