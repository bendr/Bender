<app xmlns="http://bender.igel.co.jp" xmlns:e="http://bender.igel.co.jp/e">
  <title>A color wheel for color chooser</title>
  <script><![CDATA[

  ]]></script>
  <controller>
    <script><![CDATA[

      $_.handleEvent = function(e)
      {
        if (e.type) {
          // DOM event -> cursor
        } else {
          this.context = this.outlets.canvas.getContext("2d");
          var cx = this.outlets.canvas.width / 2;
          var cy = this.outlets.canvas.height / 2;
          var r = Math.min(cx, cy) - 4;
          draw_wheel(this.context, cx, cy, r, 1);
        }
      };

      var draw_wheel = function(context, cx, cy, r, v)
      {
        var img = context.createImageData(context.canvas.width,
          context.canvas.height);
        var rr = r * r;
        for (var x = cx - r; x <= cx + r; ++x) {
          for (var y = cy - r; y <= cy + r; ++y) {
            var dx = cx - x;
            var dy = cy - y;
            var dd = dx * dx + dy * dy;
            if (dd < rr) {
              var h = Math.atan2(dy, dx) + Math.PI;
              var color = flexo.hsv_to_rgb(h, Math.sqrt(dd / rr), v);
              var index = (x + y * img.width) * 4;
              img.data[index + 0] = color[0];
              img.data[index + 1] = color[1];
              img.data[index + 2] = color[2];
              img.data[index + 3] = 255;
            }
          }
        }
        context.putImageData(img, 0, 0);
        context.beginPath();
        context.lineWidth = 2;
        context.arc(cx, cy, r, 0, 2 * Math.PI, false);
        context.stroke();
      };
    ]]></script>
    <listen event="@ready"/>
    <connect outlet="canvas" target="color-circle"/>
  </controller>
  <root-view>
    <canvas xmlns="http://www.w3.org/1999/xhtml" id="color-circle" width="400"
      height="400"/>
  </root-view>
</app>
